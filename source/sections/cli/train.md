

(train)=

# `train`

The `train` program trains either Conformal or Venn-ABERS predictors, based on the precomputed data sets generated by the {ref}`precompute` program. Some semantics is needed before diving deeper into the available parameters. In the CLI the underlying ML model is called the **scorer** - i.e. the model produces a score (the prediction) that the nonconformity function takes as input and produces the nonconformity score. The same applies for the Venn-ABERS predictor, which acts upon the score (prediction from the ML model) when producing its predictions using the isotonic regression. In the same notion, an error model is called an **error-scorer** - producing another score (prediction of expected error in the scorer-prediction) that can be given to the nonconformity function (if applicable). 

```{contents} Table of Contents
:backlinks: top
:depth: 3
```

## Usage manual

The full usage manual can be retrieved by running command:

```bash
> ./cpsign-[version]-uber.jar train
```

Note that there are default values for many parameters, and they are chosen in 

## Example Usage (ACP regression)

```bash
> java -jar cpsign-[version].jar train \
   --license /path/to/Standard-license.license \
   -td sdf /path/to/datafile.sdf \
   -e "BIO" \
   -nr 5 \
   -i liblinear \
   --model-out /tmp/Chang_BIO.cpsign \
   --model-name Chang_BIO \
   -pt 2


Running with Standard License registered to [Name] at [Company]. Expiry
date is [Date]

Reading train file and performing signature generation..
Successfully parsed 34 molecules. Generated 286 new signatures.

Training ACP Regression predictor with 5 models
 - Trained model 1/5
 - Trained model 2/5
 - Trained model 3/5
 - Trained model 4/5
 - Trained model 5/5

Saving model to file..
Finished model saved at:
/private/tmp/Chang_BIO.cpsign
```


## Percentiles: important performance note

The optional parameter `--percentiles` controls if and how many records should be used to compute atom contributions of molecules specified by the `--percentiles-data` parameter. These atom contributions are only used in case prediction images should be generated at some point (see {ref}`Molecule Gradient<molecule-gradient>` for more details), in order to normalize these predicted gradients needed for the images. This step is **very time-consuming**, especially if you are training a TCP model. For this reason the default is to skip this completely, and using it should only be done in case you really are going to need it.


## Nonconformity Measures

The available nonconformity functions can be retrieved using the `explain ncm` command, and more information about the ones supplied with cpsign can be found in the {ref}`Nonconformity measures <nonconf-measure>` section.


## Note on parallel model training 

CPSign does not support multithreading or parallel execution directly, partly due to third party dependencies that are not thread safe. Instead, parallel training can be implemented by the user by first running the `precompute` once, followed by several invocation to `train` made by different processes. In this way an aggregated conformal prediction (ACP) model can trained in parallel - where different ICPs are trained in parallel - and then later aggregated into the complete ACP model by running either the {ref}`aggregate` or the {ref}`fast-aggregate` program. For most use cases this may not be worth the effort as the training time is usually fairly quick, but for large data sets or in case a kernel based SVM is used this might be worth trying out. When only training part of an ACP, the `--seed` parameter must be given (and be the same for all runs) and the explicit ICP indices must be given for each invocation of `train` (controlled by the `--splits` parameter).